<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Axora - Upload Audio</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      color: white;
    }
    .container { width: 100%; max-width: 400px; text-align: center; }
    .logo {
      width: 80px; height: 80px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-radius: 20px;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 24px;
      font-size: 32px;
    }
    h1 { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
    .subtitle { color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 32px; }
    .upload-zone {
      background: rgba(255,255,255,0.05);
      border: 2px dashed rgba(255,255,255,0.2);
      border-radius: 16px;
      padding: 32px 24px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upload-zone:active { background: rgba(99, 102, 241, 0.1); border-color: #6366f1; }
    .upload-icon { font-size: 48px; margin-bottom: 16px; }
    .upload-text { font-size: 16px; margin-bottom: 8px; }
    .upload-hint { font-size: 12px; color: rgba(255,255,255,0.4); }
    input[type="file"] { display: none; }
    .btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      width: 100%; padding: 16px 24px;
      font-size: 16px; font-weight: 600;
      border: none; border-radius: 12px;
      cursor: pointer;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      transition: transform 0.2s;
    }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .selected-file {
      background: rgba(99, 102, 241, 0.2);
      border: 1px solid rgba(99, 102, 241, 0.4);
      border-radius: 12px;
      padding: 16px; margin-bottom: 16px;
      display: flex; align-items: center; gap: 12px;
    }
    .file-icon { font-size: 24px; }
    .file-info { flex: 1; text-align: left; }
    .file-name { font-weight: 500; font-size: 14px; word-break: break-all; }
    .file-size { font-size: 12px; color: rgba(255,255,255,0.5); }
    .remove-file {
      background: rgba(239, 68, 68, 0.2); border: none; color: #ef4444;
      width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 18px;
    }
    .progress-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin-top: 16px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #6366f1, #8b5cf6); width: 0%; transition: width 0.3s; }
    .progress-text { font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 8px; }
    .error { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #fca5a5; padding: 16px; border-radius: 12px; margin-bottom: 16px; }
    .success { background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); color: #86efac; padding: 24px; border-radius: 16px; }
    .success-icon { font-size: 48px; margin-bottom: 16px; }
    .hidden { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">üéôÔ∏è</div>
    <h1>Axora PPP</h1>
    <p class="subtitle">Importez votre enregistrement d'entretien</p>
    
    <div id="error-box" class="error hidden"></div>
    <div id="loading" class="subtitle">V√©rification de la session...</div>
    
    <div id="upload-section" class="hidden">
      <div class="upload-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
        <div class="upload-icon">üìÅ</div>
        <p class="upload-text">Touchez pour s√©lectionner</p>
        <p class="upload-hint">M4A, MP3, WAV ‚Ä¢ Max 50 MB</p>
      </div>
      
      <div id="file-preview" class="hidden">
        <div class="selected-file">
          <span class="file-icon">üéµ</span>
          <div class="file-info">
            <div class="file-name" id="file-name"></div>
            <div class="file-size" id="file-size"></div>
          </div>
          <button class="remove-file" id="remove-file" onclick="clearFile()">‚úï</button>
        </div>
      </div>
      
      <input type="file" id="file-input" accept="audio/*,.m4a,.mp3,.wav,.aac" onchange="handleFileSelect(event)">
      
      <button class="btn" id="select-btn" onclick="document.getElementById('file-input').click()">üìÇ Choisir depuis Fichiers</button>
      <button class="btn hidden" id="upload-btn" onclick="uploadFile()">
        <span id="upload-btn-text">üì§ Envoyer</span>
        <span class="spinner hidden" id="spinner"></span>
      </button>
      
      <div id="progress-section" class="hidden">
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        <p class="progress-text" id="progress-text">Envoi en cours...</p>
      </div>
    </div>
    
    <div id="success-section" class="hidden">
      <div class="success">
        <div class="success-icon">‚úÖ</div>
        <h2>Upload r√©ussi !</h2>
        <p>Retournez sur Axora pour voir la synth√®se.</p>
        <p style="margin-top: 16px; font-size: 12px; opacity: 0.7;">Vous pouvez fermer cette page.</p>
      </div>
    </div>
  </div>

  <script>
    var SUPABASE_URL = 'https://nnngmmibmaeoilmfgwzs.supabase.co';
    var API_URL = SUPABASE_URL + '/functions/v1/upload-webapp';
    var params = new URLSearchParams(window.location.search);
    var token = params.get('token');
    var selectedFile = null;
    
    function showError(msg) {
      document.getElementById('error-box').textContent = '‚ö†Ô∏è ' + msg;
      document.getElementById('error-box').classList.remove('hidden');
      document.getElementById('loading').classList.add('hidden');
    }
    
    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / 1048576).toFixed(1) + ' MB';
    }
    
    function handleFileSelect(event) {
      var file = event.target.files[0];
      if (!file) return;
      if (file.size > 50 * 1024 * 1024) {
        alert('Fichier trop volumineux (max 50 MB)');
        return;
      }
      selectedFile = file;
      document.getElementById('file-name').textContent = file.name;
      document.getElementById('file-size').textContent = formatSize(file.size);
      document.getElementById('file-preview').classList.remove('hidden');
      document.getElementById('select-btn').classList.add('hidden');
      document.getElementById('upload-btn').classList.remove('hidden');
      document.getElementById('upload-btn').disabled = false;
    }
    
    function clearFile() {
      selectedFile = null;
      document.getElementById('file-input').value = '';
      document.getElementById('file-preview').classList.add('hidden');
      document.getElementById('select-btn').classList.remove('hidden');
      document.getElementById('upload-btn').classList.add('hidden');
    }
    
    function uploadFile() {
      if (!selectedFile) return;
      
      var btn = document.getElementById('upload-btn');
      var btnText = document.getElementById('upload-btn-text');
      var spinner = document.getElementById('spinner');
      var progress = document.getElementById('progress-section');
      var progressFill = document.getElementById('progress-fill');
      var progressText = document.getElementById('progress-text');
      
      btn.disabled = true;
      btnText.textContent = 'Envoi...';
      spinner.classList.remove('hidden');
      progress.classList.remove('hidden');
      
      var formData = new FormData();
      formData.append('file', selectedFile);
      formData.append('token', token);
      
      var xhr = new XMLHttpRequest();
      xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
          var pct = Math.round((e.loaded / e.total) * 100);
          progressFill.style.width = pct + '%';
          progressText.textContent = 'Envoi: ' + pct + '%';
        }
      };
      
      xhr.onload = function() {
        if (xhr.status === 200) {
          progressFill.style.width = '100%';
          progressText.textContent = 'Traitement en cours...';
          setTimeout(function() {
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('success-section').classList.remove('hidden');
          }, 500);
        } else {
          var errMsg = 'Upload √©chou√©';
          try { errMsg = JSON.parse(xhr.responseText).error || errMsg; } catch(e) {}
          alert('Erreur: ' + errMsg);
          btn.disabled = false;
          btnText.textContent = 'üì§ Envoyer';
          spinner.classList.add('hidden');
          progress.classList.add('hidden');
        }
      };
      
      xhr.onerror = function() {
        alert('Erreur r√©seau. V√©rifiez votre connexion.');
        btn.disabled = false;
        btnText.textContent = 'üì§ Envoyer';
        spinner.classList.add('hidden');
        progress.classList.add('hidden');
      };
      
      xhr.open('POST', API_URL + '?token=' + token);
      xhr.send(formData);
    }
    
    // Init
    if (!token) {
      showError('Token manquant. Veuillez rescanner le QR code.');
    } else {
      // Validate token with API
      fetch(API_URL + '?token=' + token + '&validate=1', { method: 'HEAD' })
        .then(function(r) {
          document.getElementById('loading').classList.add('hidden');
          if (r.ok) {
            document.getElementById('upload-section').classList.remove('hidden');
          } else {
            showError('Session invalide ou expir√©e.');
          }
        })
        .catch(function() {
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('upload-section').classList.remove('hidden');
        });
    }
  </script>
</body>
</html>
